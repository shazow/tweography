<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>

<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<meta content="en-us" http-equiv="Content-Language" />

<title>tweography | Where have I tweeted from?</title>

<script src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="/static/js/sha1.js"></script>
<script type="text/javascript" src="/static/js/oauth.js"></script>
<script type="text/javascript" src="/static/js/jsoauthapi.js?1"></script>
<script type="text/javascript">
    google.load("jquery", "1");
    google.load("maps", "2", {other_params: "sensor=false"});

    function draw_map() {
        if (!GBrowserIsCompatible()) return;
        map = new GMap2(document.getElementById("map"));

        map.addControl(new GSmallMapControl());

        return map;
    }

    var map;

    function render_tweets(r) {
        var found_first = false;
        $.each(r, function(i, o) {
            if(!o.geo) return true;

            var coords = o.geo.coordinates;

            if(!found_first) {
                found_first = true;
                set_center(coords[0], coords[1]);
            }
            var icon = new GIcon(G_DEFAULT_ICON);
            icon.image = "http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png";
            icon.iconSize = new GSize(32, 32);

            var marker = new GMarker(new GLatLng(coords[0], coords[1]), { icon: icon });
            map.addOverlay(marker)
        });
    };

    function set_logged_in(username) {
        $(".username").text(username);
        $(".user").removeClass('hidden');
    };

    function set_center(lat, lng) {
        var pos = new GLatLng(lat, lng);
        map.setCenter(pos, 11);
    };

    function init_loggedin() {
        twitter_api.user_timeline({count: 200}, function(r) {
            set_logged_in(r[0].user.screen_name);
            render_tweets(r);
        });
    };

    google.setOnLoadCallback(function() {
        OAuth.app = "tweography";
        if(window.location.host == "localhost:8080") OAuth.app = "tweography-test";

        if(OAuth.accessor == undefined) {
            $(".intro").removeClass('hidden');
            $("#login").click(function() { OAuth.auth_redirect(); });
        } else {
            $(".results").removeClass('hidden');
            $("#logout").click(function() { clear_cookies(); window.location.reload(); }).show();
            init_loggedin();
        }

        map = draw_map();
    });
</script>
<script type="text/javascript" src="/static/js/jquery.jsonp-1.1.0.min.js"></script>
<script type="text/javascript" src="/static/js/util.js?1"></script>
<script type="text/javascript" src="/static/js/tweography.js?1"></script>
<link rel="stylesheet" href="/static/css/tweography.css?1" type="text/css">
</head>
<body>

<div id="header">
    <h1><a href="/">Tweography</a></h1>
    <div class="user hidden"><div id="extra">Hi, @<span class="username">you</span>! <span class="button" id="logout">Sign out?</span></div></div>
</div>

<div class="intro content hidden">
    <img src="/static/images/mini-map.png" title="My Tweets plus Google Maps = Tweography" id="mini-map"/>
    <div>
        <h2 id="progress">
            Your tweets on a map = Tweography.
        </h2>
        <ol>
            <li><strong>Step 1.</strong> <img src="/static/images/Sign-in-with-Twitter-darker.png" alt="Sign in with Twitter" id="login" class="button" style="margin-bottom: -6px;" /></li>
            <li><strong>Step 2.</strong> Enjoy.</li>
    </div>
</div>

<div class="results content hidden">
    <h2 id="progress">Where has @<span class="username">you</span> been tweeting?</h2>
    <div id="map" style="height: 300px;"></div>
</div>

<div id="footer">A weeknight project by @<a href="http://twitter.com/limedaring">limedaring</a> and @<a href="http://twitter.com/shazow">shazow</a>.</div>

</body>
</html>
